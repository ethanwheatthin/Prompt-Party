# Copilot / AI agent instructions — Prompt-Party

Purpose: provide concise, actionable orientation for an AI coding agent to be productive in this repo.

High-level architecture
- Unity front-end: the Unity project root (open with Unity Editor matching [ProjectSettings/ProjectVersion.txt](ProjectSettings/ProjectVersion.txt#L1)) contains game code under [Assets/Scripts](Assets/Scripts). Scenes are in [Assets/Scenes] and reusable objects under [Assets/Prefabs]. The project uses the Unity Input System (see [Assets/InputSystem_Actions.inputactions] and generated [Assets/InputSystem_Actions.cs](Assets/InputSystem_Actions.cs#L1)).
- Backend: a small Node/TypeScript server in `backend/` provides room management, websockets and static player UI. Key files: [backend/src/server.ts](backend/src/server.ts#L1), [backend/src/ws/index.ts](backend/src/ws/index.ts#L1), [backend/src/lib/roomManager.ts](backend/src/lib/roomManager.ts#L1), and route controllers at [backend/src/controllers/index.ts](backend/src/controllers/index.ts#L1).

Key implementation notes (do not guess; rely on these files)
- Backend uses Fastify + @fastify/websocket; websockets endpoint is `/ws` and static player UI is served from `backend/public` (see server.ts).
- Room state is authoritative in `backend/src/lib/roomManager.ts`. Join codes are validated and generated there; tests assert the format: `PP[A-Z2-9]{6}` (see [backend/src/tests/roomManager.test.ts](backend/src/tests/roomManager.test.ts#L1)).
- Auth tokens are JWTs signed with `process.env.JWT_SECRET` (fallback `dev-secret`). Treat `JWT_SECRET` as required for production flows; `.env` is used (dotenv in server.ts).
- Input system code is auto-generated: do NOT edit `Assets/InputSystem_Actions.cs` — edit the `.inputactions` asset in the Editor instead.
- Unity-specific assets (URP, TextMesh Pro) exist; follow Editor workflows for any C# or Scene edits — Unity regenerates `.csproj` files and compiles C# itself.

Developer workflows (concrete commands)
- Backend local dev (from repo root):
  - `cd backend`
  - `npm install`
  - `npm run dev` (runs `ts-node-dev` and starts server on `0.0.0.0:${PORT||3000}`)
  - Open `http://<YOUR_LAN_IP>:3000/player.html` on a phone to test player join (see backend/README.md).
- Backend build & test:
  - `cd backend && npm run build` (TypeScript compile)
  - `cd backend && npm run test` (runs `vitest`)
- Unity development:
  - Open the Unity project in the Editor version listed in [ProjectSettings/ProjectVersion.txt](ProjectSettings/ProjectVersion.txt#L1).
  - Use Play mode to host a room from Unity (Unity will contact backend on the LAN). Changes to C# require the Editor to recompile; avoid editing generated code files.

Patterns & conventions specific to this repo
- Network: the Unity host creates rooms; phones connect to the backend static `player.html` and authenticate to the websocket using the JWT returned by POST `/join` or the create-room flow. The server broadcasts room state to connected sockets (see `broadcastRoomState` usage in `backend/src/ws/index.ts`).
- Tests: unit tests for backend use `vitest` and are located under `backend/src/tests`.
- Files generated by tools: `Assets/InputSystem_Actions.cs` is generated by the Input System; `Assembly-CSharp.csproj` and other `.csproj` files are generated/managed by Unity — avoid manual edits.

Where to start when asked to change behavior
1. Backend-only change (API, room logic): edit `backend/src/lib/*` or `backend/src/controllers/*`, run `npm run test`, and `npm run dev` to verify. Check logs from Fastify (logger enabled in server.ts).
2. Add/modify player UI: edit `backend/public` (static site served by the server) and reload the mobile client at `/player.html`.
3. Unity gameplay/visual change: open Unity Editor, modify Scenes/Prefabs/Scripts under `Assets/`, press Play to validate. For input remapping, edit the `.inputactions` asset; re-generate InputSystem code via the Editor.

When in doubt / quick checks
- To confirm backend port and host: inspect `[backend/src/server.ts](backend/src/server.ts#L1)` (default port 3000, host 0.0.0.0).
- To view JWT expectations and join-code format: check `[backend/src/lib/roomManager.ts](backend/src/lib/roomManager.ts#L1)` and tests at `[backend/src/tests/roomManager.test.ts](backend/src/tests/roomManager.test.ts#L1)`.

If you modify or add files that require Unity to import them, mention that the user should open Unity Editor to allow asset import and script compilation.

Questions for the maintainer (ask before large changes)
- Preferred process for environment variables (should `JWT_SECRET` be placed in repo `.env.example`?).
- Should the join-code or token format be considered stable or open to change?

If anything above is unclear or you'd like me to expand sections (e.g., add example request/response shapes, or show common edit->test loops), say which section to expand.
